
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>【转】MySQL存储过程例子，包含事务，参数，嵌套调用，游标，循环等 - Woody's 电子游牧日志</title>
	<meta name="author" content="Woody.Xu">

	
	<meta name="description" content="1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Woody's 电子游牧日志" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">Woody's 电子游牧日志</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about/">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about/">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:woody1983.github.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/unix1983@gmail.com?rel=author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/xiaoputi" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/woody1983" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:woody1983.github.com">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">【转】MySQL存储过程例子，包含事务，参数，嵌套调用，游标，循环等</h1>
	<div class="entry-content"><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">drop</span> <span class="k">procedure</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">pro_rep_shadow_rs</span><span class="p">;</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">|</span>
</span><span class='line'><span class="c1">----------------------------------   </span>
</span><span class='line'><span class="c1">-- rep_shadow_rs   </span>
</span><span class='line'><span class="c1">-- 用来处理信息的增加，更新和删除   </span>
</span><span class='line'><span class="c1">-- 每次只更新上次以来没有做过的数据   </span>
</span><span class='line'><span class="c1">-- 根据不同的标志位   </span>
</span><span class='line'><span class="c1">-- 需要一个输出的参数，   </span>
</span><span class='line'><span class="c1">-- 如果返回为0，则调用失败，事务回滚   </span>
</span><span class='line'><span class="c1">-- 如果返回为1，调用成功，事务提交   </span>
</span><span class='line'><span class="c1">--   </span>
</span><span class='line'><span class="c1">-- 测试方法   </span>
</span><span class='line'><span class="c1">-- call pro_rep_shadow_rs(@rtn);   </span>
</span><span class='line'><span class="c1">-- select @rtn;   </span>
</span><span class='line'><span class="c1">----------------------------------   </span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_rep_shadow_rs</span><span class="p">(</span><span class="k">out</span> <span class="n">rtn</span> <span class="nb">int</span><span class="p">)</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'>    <span class="c1">-- 声明变量，所有的声明必须在非声明的语句前面   </span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">iLast_rep_sync_id</span> <span class="nb">int</span> <span class="k">default</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">iMax_rep_sync_id</span> <span class="nb">int</span> <span class="k">default</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 如果出现异常，或自动处理并rollback,但不再通知调用方了   </span>
</span><span class='line'>    <span class="c1">-- 如果希望应用获得异常，需要将下面这一句，以及启动事务和提交事务的语句全部去掉   </span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">exit</span> <span class="k">handler</span> <span class="k">for</span> <span class="k">sqlexception</span> <span class="k">rollback</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 查找上一次的   </span>
</span><span class='line'>    <span class="k">select</span> <span class="n">eid</span> <span class="k">into</span> <span class="n">iLast_rep_sync_id</span> <span class="k">from</span> <span class="n">rep_de_proc_log</span> <span class="k">where</span> <span class="n">tbl</span><span class="o">=</span><span class="s1">&#39;rep_shadow_rs&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 如果不存在，则增加一行   </span>
</span><span class='line'>    <span class="n">if</span> <span class="n">iLast_rep_sync_id</span><span class="o">=-</span><span class="mi">1</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">insert</span> <span class="k">into</span> <span class="n">rep_de_proc_log</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span><span class="n">eid</span><span class="p">,</span><span class="n">tbl</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;rep_shadow_rs&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">set</span> <span class="n">iLast_rep_sync_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- 下一个数字   </span>
</span><span class='line'>    <span class="k">set</span> <span class="n">iLast_rep_sync_id</span><span class="o">=</span><span class="n">iLast_rep_sync_id</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 设置默认的返回值为0：失败   </span>
</span><span class='line'>    <span class="k">set</span> <span class="n">rtn</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- 启动事务   </span>
</span><span class='line'>    <span class="k">start</span> <span class="n">transaction</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 查找最大编号   </span>
</span><span class='line'>    <span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">rep_sync_id</span><span class="p">)</span> <span class="k">into</span> <span class="n">iMax_rep_sync_id</span> <span class="k">from</span> <span class="n">rep_shadow_rs</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 有新数据   </span>
</span><span class='line'>    <span class="n">if</span> <span class="n">iMax_rep_sync_id</span><span class="o">&gt;=</span><span class="n">iLast_rep_sync_id</span> <span class="k">then</span>
</span><span class='line'>        <span class="c1">-- 调用   </span>
</span><span class='line'>        <span class="k">call</span> <span class="n">pro_rep_shadow_rs_do</span><span class="p">(</span><span class="n">iLast_rep_sync_id</span><span class="p">,</span><span class="n">iMax_rep_sync_id</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">-- 更新日志   </span>
</span><span class='line'>        <span class="k">update</span> <span class="n">rep_de_proc_log</span> <span class="k">set</span> <span class="n">rid</span><span class="o">=</span><span class="n">iLast_rep_sync_id</span><span class="p">,</span><span class="n">eid</span><span class="o">=</span><span class="n">iMax_rep_sync_id</span> <span class="k">where</span> <span class="n">tbl</span><span class="o">=</span><span class="s1">&#39;rep_shadow_rs&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- 运行没有异常，提交事务   </span>
</span><span class='line'>    <span class="k">commit</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 设置返回值为1 </span>
</span><span class='line'>    <span class="k">set</span> <span class="n">rtn</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="o">|</span>
</span><span class='line'><span class="k">delimiter</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<!-- more-->


<blockquote></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">drop</span> <span class="k">procedure</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">pro_rep_shadow_rs_do</span><span class="p">;</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">|</span>
</span><span class='line'><span class="c1">---------------------------------   </span>
</span><span class='line'><span class="c1">-- 处理指定编号范围内的数据   </span>
</span><span class='line'><span class="c1">-- 需要输入2个参数   </span>
</span><span class='line'><span class="c1">-- last_rep_sync_id 是编号的最小值   </span>
</span><span class='line'><span class="c1">-- max_rep_sync_id 是编号的最大值   </span>
</span><span class='line'><span class="c1">-- 无返回值   </span>
</span><span class='line'><span class="c1">---------------------------------   </span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">pro_rep_shadow_rs_do</span><span class="p">(</span><span class="n">last_rep_sync_id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_rep_sync_id</span> <span class="nb">int</span><span class="p">)</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">iRep_operationtype</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">iRep_status</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">iRep_Sync_id</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">iId</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 这个用于处理游标到达最后一行的情况   </span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">stop</span> <span class="nb">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 声明游标   </span>
</span><span class='line'>    <span class="k">declare</span> <span class="n">cur</span> <span class="k">cursor</span> <span class="k">for</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">Rep_operationtype</span><span class="p">,</span><span class="n">iRep_status</span><span class="p">,</span><span class="n">rep_sync_id</span> <span class="k">from</span> <span class="n">rep_shadow_rs</span> <span class="k">where</span> <span class="n">rep_sync_id</span> <span class="k">between</span> <span class="n">last_rep_sync_id</span> <span class="k">and</span> <span class="n">max_rep_sync_id</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 声明游标的异常处理，设置一个终止标记   </span>
</span><span class='line'>    <span class="k">declare</span> <span class="k">CONTINUE</span> <span class="k">HANDLER</span> <span class="k">FOR</span> <span class="k">SQLSTATE</span> <span class="s1">&#39;02000&#39;</span> <span class="k">SET</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- 打开游标   </span>
</span><span class='line'>    <span class="k">open</span> <span class="n">cur</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- 读取一行数据到变量   </span>
</span><span class='line'>    <span class="k">fetch</span> <span class="n">cur</span> <span class="k">into</span> <span class="n">iId</span><span class="p">,</span><span class="n">iRep_operationtype</span><span class="p">,</span><span class="n">iRep_status</span><span class="p">,</span><span class="n">iRep_Sync_id</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 这个就是判断是否游标已经到达了最后   </span>
</span><span class='line'>    <span class="n">while</span> <span class="n">stop</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>        <span class="c1">-- 各种判断   </span>
</span><span class='line'>        <span class="n">if</span> <span class="n">iRep_operationtype</span><span class="o">=</span><span class="s1">&#39;I&#39;</span> <span class="k">then</span>
</span><span class='line'>            <span class="k">insert</span> <span class="k">into</span> <span class="n">rs0811</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">fnbm</span><span class="p">)</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">fnbm</span> <span class="k">from</span> <span class="n">rep_shadow_rs</span> <span class="k">where</span> <span class="n">rep_sync_id</span><span class="o">=</span><span class="n">iRep_sync_id</span><span class="p">;</span>
</span><span class='line'>        <span class="n">elseif</span> <span class="n">iRep_operationtype</span><span class="o">=</span><span class="s1">&#39;U&#39;</span> <span class="k">then</span>
</span><span class='line'>        <span class="k">begin</span>
</span><span class='line'>            <span class="n">if</span> <span class="n">iRep_status</span><span class="o">=</span><span class="s1">&#39;A&#39;</span> <span class="k">then</span>
</span><span class='line'>                <span class="k">insert</span> <span class="k">into</span> <span class="n">rs0811</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">fnbm</span><span class="p">)</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">fnbm</span> <span class="k">from</span> <span class="n">rep_shadow_rs</span> <span class="k">where</span> <span class="n">rep_sync_id</span><span class="o">=</span><span class="n">iRep_sync_id</span><span class="p">;</span>
</span><span class='line'>            <span class="n">elseif</span> <span class="n">iRep_status</span><span class="o">=</span><span class="s1">&#39;B&#39;</span> <span class="k">then</span>
</span><span class='line'>                <span class="k">delete</span> <span class="k">from</span> <span class="n">rs0811</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="n">iId</span><span class="p">;</span>
</span><span class='line'>            <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'>        <span class="k">end</span><span class="p">;</span>
</span><span class='line'>        <span class="n">elseif</span> <span class="n">iRep_operationtype</span><span class="o">=</span><span class="s1">&#39;D&#39;</span> <span class="k">then</span>
</span><span class='line'>            <span class="k">delete</span> <span class="k">from</span> <span class="n">rs0811</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="n">iId</span><span class="p">;</span>
</span><span class='line'>        <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">-- 读取下一行的数据    </span>
</span><span class='line'>        <span class="k">fetch</span> <span class="n">cur</span> <span class="k">into</span> <span class="n">iId</span><span class="p">,</span><span class="n">iRep_operationtype</span><span class="p">,</span><span class="n">iRep_status</span><span class="p">,</span><span class="n">iRep_Sync_id</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span> <span class="n">while</span><span class="p">;</span> <span class="c1">-- 循环结束   </span>
</span><span class='line'>    <span class="k">close</span> <span class="n">cur</span><span class="p">;</span> <span class="c1">-- 关闭游标   </span>
</span><span class='line'><span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="n">use</span> <span class="n">testprocedure</span><span class="p">;</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">simpleproce1</span> <span class="p">(</span><span class="k">out</span> <span class="n">par1</span> <span class="nb">int</span><span class="p">)</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">into</span> <span class="n">par1</span> <span class="k">from</span> <span class="n">proce</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">delimiter</span> <span class="p">;</span>
</span><span class='line'><span class="k">call</span> <span class="n">simpleproce1</span><span class="p">(</span><span class="o">@</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'><span class="k">select</span> <span class="o">@</span><span class="n">a</span><span class="p">;</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span><span class="err">每次只有单一的行可以被取回</span><span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">name</span> <span class="k">into</span> <span class="n">par1</span><span class="p">,</span><span class="n">par2</span> <span class="k">from</span> <span class="n">proce</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span><span class="err">中的</span><span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="n">use</span> <span class="n">testprocedure</span><span class="p">;</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">simpleproce2</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">simpleproce2</span> <span class="p">(</span><span class="k">out</span> <span class="n">par1</span> <span class="nb">int</span><span class="p">,</span><span class="k">out</span> <span class="n">par2</span> <span class="nb">char</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">name</span> <span class="k">into</span> <span class="n">par1</span><span class="p">,</span><span class="n">par2</span> <span class="k">from</span> <span class="n">proce</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">delimiter</span> <span class="p">;</span>
</span><span class='line'><span class="k">call</span> <span class="n">simpleproce2</span><span class="p">(</span><span class="o">@</span><span class="n">a</span><span class="p">,</span><span class="o">@</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="k">select</span> <span class="o">@</span><span class="n">a</span><span class="p">,</span><span class="o">@</span><span class="n">b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">##</span> <span class="o">*********</span><span class="k">second</span> <span class="n">test</span><span class="p">,</span><span class="k">function</span><span class="o">************</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">3</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">hello</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">function</span> <span class="n">hello</span><span class="p">(</span><span class="n">s</span> <span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span> <span class="k">returns</span> <span class="nb">char</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span class='line'><span class="k">return</span> <span class="n">concat</span><span class="p">(</span><span class="s1">&#39;Hello, &#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="s1">&#39;!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">delimiter</span> <span class="p">;</span>
</span><span class='line'><span class="k">select</span> <span class="n">hello</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">show</span> <span class="k">create</span> <span class="k">function</span> <span class="n">testprocedure</span><span class="p">.</span><span class="n">helloG</span>
</span><span class='line'><span class="o">#</span><span class="err">它返回子程序的特征，如数据库，名字，类型，创建者及创建和修改日期</span>
</span><span class='line'><span class="k">show</span> <span class="k">function</span> <span class="n">status</span> <span class="k">like</span> <span class="s1">&#39;hello&#39;</span><span class="k">G</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">4</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">#</span><span class="err">注意</span><span class="n">name</span><span class="err">不能和字段名相同</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">test</span> <span class="o">//</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">test</span> <span class="p">()</span>
</span><span class='line'><span class="k">BEGIN</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;bob&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">newname</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">xid</span> <span class="nb">INT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span><span class="n">id</span> <span class="k">INTO</span> <span class="n">newname</span><span class="p">,</span><span class="n">xid</span>
</span><span class='line'>      <span class="k">FROM</span> <span class="n">proce</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span><span class='line'>    <span class="k">SELECT</span> <span class="n">newname</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">test1</span><span class="p">()</span> <span class="o">//</span>
</span><span class='line'><span class="o">#***</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">test2</span> <span class="o">//</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">test2</span> <span class="p">()</span>
</span><span class='line'><span class="k">BEGIN</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">newname</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">xid</span> <span class="nb">INT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span><span class="n">id</span> <span class="k">INTO</span> <span class="n">newname</span><span class="p">,</span><span class="n">xid</span>
</span><span class='line'>      <span class="k">FROM</span> <span class="n">proce</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">SELECT</span> <span class="n">newname</span><span class="p">,</span><span class="n">xid</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">test2</span><span class="p">()</span> <span class="o">//</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">5</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">use</span> <span class="n">testprocedure</span><span class="p">;</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">p1</span> <span class="p">()</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">proce</span><span class="p">;</span>
</span><span class='line'><span class="k">call</span> <span class="n">p1</span><span class="p">();</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="err">注意此处的</span><span class="k">handler</span><span class="err">是设置</span><span class="k">SQLSTATE</span><span class="err">值，</span><span class="n">SQLWARNING</span><span class="err">是对所有以</span><span class="mi">01</span><span class="err">开头的</span><span class="k">SQLSTATE</span><span class="err">代码的速记</span>
</span><span class='line'><span class="o">#</span><span class="k">NOT</span> <span class="k">FOUND</span><span class="err">是对所有以</span><span class="mi">02</span><span class="err">开头的</span><span class="k">SQLSTATE</span><span class="err">代码的速记</span>
</span><span class='line'><span class="o">#</span><span class="k">SQLEXCEPTION</span><span class="err">是对所有没有被</span><span class="n">SQLWARNING</span><span class="err">或</span><span class="k">NOT</span> <span class="k">FOUND</span><span class="err">捕获的</span><span class="k">SQLSTATE</span><span class="err">代码的速记</span>
</span><span class='line'><span class="o">#</span><span class="k">DECLARE</span> <span class="k">CONTINUE</span> <span class="k">HANDLER</span><span class="err">声明</span><span class="k">CONTINUE</span><span class="err">异常处理</span>
</span><span class='line'><span class="o">#</span><span class="err">事实上这里的</span><span class="mi">23000</span><span class="k">SQLSTATE</span><span class="err">是更常用的，当外键约束出错或主键约束出错就被调用了。</span>
</span><span class='line'><span class="o">#</span><span class="err">当没有发生该</span><span class="mi">23000</span><span class="err">异常时，</span> <span class="k">select</span> <span class="o">@</span><span class="n">x2</span><span class="err">的值将是</span><span class="k">null</span><span class="p">,</span><span class="err">而不是</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'><span class="o">#</span><span class="err">并且后面的第</span><span class="mi">2</span><span class="err">个语句执行时将会报主键约束错误，此时</span><span class="o">@</span><span class="n">x2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">@</span><span class="n">x</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="err">虽然第</span><span class="mi">2</span><span class="err">句有了异常，但是后面的语句继续执行</span>
</span><span class='line'><span class="o">#</span><span class="err">保存到数据的数据是</span><span class="mi">3</span><span class="p">,</span><span class="n">test3</span><span class="err">和</span><span class="mi">5</span><span class="p">,</span><span class="n">test5</span>
</span><span class='line'><span class="n">use</span> <span class="n">testprocedure</span><span class="p">;</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">handlerdemo</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">handlerdemo</span><span class="p">()</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">declare</span> <span class="k">continue</span> <span class="k">handler</span> <span class="k">for</span> <span class="k">sqlstate</span> <span class="s1">&#39;23000&#39;</span> <span class="k">set</span> <span class="o">@</span><span class="n">x2</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="k">set</span> <span class="o">@</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="k">insert</span> <span class="k">into</span> <span class="n">proce</span> <span class="k">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;test3&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">set</span> <span class="o">@</span><span class="n">x</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="k">insert</span> <span class="k">into</span> <span class="n">proce</span> <span class="k">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;test4&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">set</span> <span class="o">@</span><span class="n">x</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
</span><span class='line'><span class="k">insert</span> <span class="k">into</span> <span class="n">proce</span> <span class="k">values</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;test5&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">set</span> <span class="o">@</span><span class="n">x</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">handlerdemo</span><span class="p">()</span><span class="o">//</span>
</span><span class='line'><span class="k">select</span> <span class="o">@</span><span class="n">x</span> <span class="o">//</span>
</span><span class='line'><span class="k">select</span> <span class="o">@</span><span class="n">x2</span> <span class="o">//</span>
</span><span class='line'><span class="o">##</span> <span class="o">************</span><span class="err">光标</span><span class="o">****************</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">7</span><span class="o">&gt;</span><span class="err">光标必须在声明处理程序之前被声明，并且变量和条件必须在声明光标或处理程序之前被声明</span>
</span><span class='line'><span class="o">#</span><span class="err">在这里先声明变量</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="k">c</span><span class="p">,</span><span class="err">后声明</span><span class="k">cursor</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">curdemo</span><span class="p">()</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">declare</span> <span class="n">done</span> <span class="nb">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="k">declare</span> <span class="n">a</span> <span class="nb">char</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
</span><span class='line'><span class="k">declare</span> <span class="n">b</span><span class="p">,</span><span class="k">c</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'><span class="k">declare</span> <span class="n">cur1</span> <span class="k">cursor</span> <span class="k">for</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">name</span> <span class="k">from</span> <span class="n">proce</span><span class="p">;</span>
</span><span class='line'><span class="k">declare</span> <span class="n">cur2</span> <span class="k">cursor</span> <span class="k">for</span> <span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="n">proce2</span><span class="p">;</span>
</span><span class='line'><span class="k">declare</span> <span class="k">continue</span> <span class="k">handler</span> <span class="k">for</span> <span class="k">sqlstate</span> <span class="s1">&#39;02000&#39;</span> <span class="k">set</span> <span class="n">done</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="n">cur1</span><span class="p">;</span>
</span><span class='line'><span class="k">open</span> <span class="n">cur2</span><span class="p">;</span>
</span><span class='line'><span class="n">repeat</span>
</span><span class='line'><span class="k">fetch</span> <span class="n">cur1</span> <span class="k">into</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">;</span>
</span><span class='line'><span class="k">fetch</span> <span class="n">cur2</span> <span class="k">into</span> <span class="k">c</span><span class="p">;</span>
</span><span class='line'><span class="n">if</span> <span class="k">not</span> <span class="n">done</span> <span class="k">then</span>
</span><span class='line'>   <span class="n">if</span> <span class="n">b</span><span class="o">&lt;</span><span class="k">c</span> <span class="k">then</span>
</span><span class='line'>     <span class="k">insert</span> <span class="k">into</span> <span class="n">proce3</span> <span class="k">values</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>   <span class="k">else</span>
</span><span class='line'>     <span class="k">insert</span> <span class="k">into</span> <span class="n">proce3</span> <span class="k">values</span><span class="p">(</span><span class="k">c</span><span class="p">,</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>   <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'><span class="k">until</span> <span class="n">done</span> <span class="k">end</span> <span class="n">repeat</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">close</span> <span class="n">cur1</span><span class="p">;</span>
</span><span class='line'><span class="k">close</span> <span class="n">cur2</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">##</span> <span class="o">****************</span> <span class="k">Case</span> <span class="o">*******************</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="k">when</span> <span class="p">...</span> <span class="k">then</span> <span class="p">;</span><span class="k">case</span> <span class="p">...</span> <span class="k">end</span> <span class="k">case</span><span class="p">;</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p13</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p13</span><span class="p">(</span><span class="k">in</span> <span class="n">par1</span> <span class="nb">int</span><span class="p">)</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">declare</span> <span class="n">var1</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'><span class="k">set</span> <span class="n">var1</span><span class="o">=</span><span class="n">par1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="n">var1</span>
</span><span class='line'><span class="k">when</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">casetest</span> <span class="k">values</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>
</span><span class='line'><span class="k">when</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">casetest</span> <span class="k">values</span><span class="p">(</span><span class="mi">18</span><span class="p">);</span>
</span><span class='line'><span class="k">else</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">casetest</span> <span class="k">values</span><span class="p">(</span><span class="mi">19</span><span class="p">);</span>
</span><span class='line'><span class="k">end</span> <span class="k">case</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p13</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p13</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p13</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p13</span><span class="p">(</span><span class="k">null</span><span class="p">)</span><span class="o">//</span>
</span><span class='line'>
</span><span class='line'><span class="o">##</span> <span class="o">****************</span> <span class="n">while</span> <span class="o">****************</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">9</span><span class="o">&gt;</span><span class="n">while</span> <span class="p">...</span> <span class="k">do</span> <span class="p">...</span> <span class="k">end</span> <span class="n">while</span><span class="p">;</span><span class="err">为了防止</span><span class="k">null</span><span class="err">的错误，</span><span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="err">是必须的</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p14</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p14</span><span class="p">()</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">declare</span> <span class="n">v</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'><span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">while</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">insert</span> <span class="k">into</span> <span class="n">casetest</span> <span class="k">values</span> <span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class='line'>      <span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">while</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p14</span><span class="p">()</span><span class="o">//</span>
</span><span class='line'><span class="o">##</span> <span class="o">*****************</span> <span class="n">repeat</span> <span class="o">*****************</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">10</span><span class="o">&gt;</span><span class="n">repeat</span> <span class="p">...</span><span class="k">until</span> <span class="p">...</span> <span class="k">end</span> <span class="n">repeat</span><span class="p">;</span> <span class="err">是执行后检查（</span><span class="k">until</span> <span class="n">v</span><span class="o">&gt;=</span><span class="mi">5</span><span class="err">），而</span><span class="n">while</span><span class="err">是执行前检查</span><span class="p">(</span><span class="n">while</span> <span class="n">v</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p15</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p15</span><span class="p">()</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">declare</span> <span class="n">v</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'><span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">repeat</span>
</span><span class='line'>    <span class="k">insert</span> <span class="k">into</span> <span class="n">casetest</span> <span class="k">values</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class='line'>    <span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="k">until</span> <span class="n">v</span> <span class="o">&gt;=</span><span class="mi">5</span>
</span><span class='line'><span class="k">end</span> <span class="n">repeat</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p15</span><span class="p">()</span><span class="o">//</span>
</span><span class='line'><span class="o">##</span> <span class="o">*****************</span> <span class="n">loops</span> <span class="o">*****************</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">11</span><span class="o">&gt;</span> <span class="n">loop</span> <span class="err">和</span><span class="n">while</span><span class="err">一样不需要初始条件，同时和</span><span class="n">repeat</span><span class="err">一样不需要结束条件</span>
</span><span class='line'><span class="o">#</span>      <span class="n">loop_label</span><span class="p">:</span> <span class="n">loop</span>
</span><span class='line'><span class="o">#</span>      <span class="p">...</span>
</span><span class='line'><span class="o">#</span>       <span class="n">if</span> <span class="p">..</span> <span class="k">then</span>
</span><span class='line'><span class="o">#</span>       <span class="n">leave</span> <span class="n">loop_label</span>
</span><span class='line'><span class="o">#</span>       <span class="k">end</span> <span class="n">if</span>
</span><span class='line'><span class="o">#</span>      <span class="k">end</span> <span class="n">loop</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p16</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p16</span><span class="p">()</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">declare</span> <span class="n">v</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'><span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">loop_label</span><span class="p">:</span> <span class="n">loop</span>
</span><span class='line'>    <span class="k">insert</span> <span class="k">into</span> <span class="n">casetest</span> <span class="k">values</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class='line'>    <span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">if</span> <span class="n">v</span> <span class="o">&gt;=</span><span class="mi">5</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">leave</span> <span class="n">loop_label</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">loop</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p16</span><span class="p">()</span><span class="o">//</span>
</span><span class='line'><span class="o">##</span> <span class="o">*****************</span> <span class="n">Labels</span> <span class="o">*****************</span>
</span><span class='line'><span class="o">#</span> <span class="o">&lt;</span><span class="mi">12</span><span class="o">&gt;</span><span class="n">labels</span><span class="err">标号；</span> <span class="err">注意此处的</span><span class="k">until</span> <span class="mi">0</span><span class="o">=</span><span class="mi">0</span><span class="err">后面没有分号“</span><span class="p">;</span><span class="err">”</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p17</span><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p17</span><span class="p">()</span>
</span><span class='line'><span class="n">label_1</span><span class="p">:</span><span class="k">begin</span>
</span><span class='line'><span class="n">label_2</span><span class="p">:</span><span class="n">while</span> <span class="mi">0</span><span class="o">=</span><span class="mi">1</span> <span class="k">do</span> <span class="n">leave</span> <span class="n">label_2</span><span class="p">;</span> <span class="k">end</span> <span class="n">while</span><span class="p">;</span>
</span><span class='line'><span class="n">label_3</span><span class="p">:</span><span class="n">repeat</span> <span class="n">leave</span> <span class="n">label_3</span><span class="p">;</span><span class="k">until</span> <span class="mi">0</span><span class="o">=</span><span class="mi">0</span> <span class="k">end</span> <span class="n">repeat</span><span class="p">;</span>
</span><span class='line'><span class="n">label_4</span><span class="p">:</span><span class="n">loop</span> <span class="n">leave</span> <span class="n">label_4</span><span class="p">;</span> <span class="k">end</span> <span class="n">loop</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p17</span><span class="p">()</span><span class="o">//</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">13</span><span class="o">&gt;</span><span class="n">labels</span> <span class="err">标号结束符；</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p18</span><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p18</span><span class="p">()</span>
</span><span class='line'><span class="n">label_1</span><span class="p">:</span><span class="k">begin</span>
</span><span class='line'><span class="n">label_2</span><span class="p">:</span><span class="n">while</span> <span class="mi">0</span><span class="o">=</span><span class="mi">1</span> <span class="k">do</span> <span class="n">leave</span> <span class="n">label_2</span><span class="p">;</span> <span class="k">end</span> <span class="n">while</span> <span class="n">label_2</span><span class="p">;</span>
</span><span class='line'><span class="n">label_3</span><span class="p">:</span><span class="n">repeat</span> <span class="n">leave</span> <span class="n">label_3</span><span class="p">;</span><span class="k">until</span> <span class="mi">0</span><span class="o">=</span><span class="mi">0</span> <span class="k">end</span> <span class="n">repeat</span> <span class="n">label_3</span><span class="p">;</span>
</span><span class='line'><span class="n">label_4</span><span class="p">:</span><span class="n">loop</span> <span class="n">leave</span> <span class="n">label_4</span><span class="p">;</span> <span class="k">end</span> <span class="n">loop</span> <span class="n">label_4</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">label_1</span><span class="p">;</span><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p18</span><span class="p">()</span><span class="o">//</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">14</span><span class="o">&gt;</span><span class="n">leave</span><span class="err">和</span><span class="n">labels</span> <span class="err">跳出和标号</span><span class="p">;</span><span class="n">leave</span> <span class="err">使程序跳出复杂的语句</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p19</span><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p19</span><span class="p">(</span><span class="n">par</span> <span class="nb">char</span><span class="p">)</span>
</span><span class='line'><span class="n">label_1</span><span class="p">:</span><span class="k">begin</span>
</span><span class='line'><span class="n">label_2</span><span class="p">:</span><span class="k">begin</span>
</span><span class='line'><span class="n">label_3</span><span class="p">:</span><span class="k">begin</span>
</span><span class='line'><span class="n">if</span> <span class="n">par</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span> <span class="k">then</span>
</span><span class='line'><span class="n">if</span> <span class="n">par</span><span class="o">=</span><span class="s1">&#39;a&#39;</span> <span class="k">then</span> <span class="n">leave</span> <span class="n">label_1</span><span class="p">;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>   <span class="k">begin</span>
</span><span class='line'>     <span class="n">if</span> <span class="n">par</span><span class="o">=</span><span class="s1">&#39;b&#39;</span> <span class="k">then</span>
</span><span class='line'>       <span class="n">leave</span> <span class="n">label_2</span><span class="p">;</span>
</span><span class='line'>     <span class="k">else</span>
</span><span class='line'>       <span class="n">leave</span> <span class="n">label_3</span><span class="p">;</span>
</span><span class='line'>     <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'>   <span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">label_3</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">label_2</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">label_1</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p19</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">//</span>
</span><span class='line'>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">15</span><span class="o">&gt;</span><span class="k">iterate</span><span class="err">迭代，必须用</span><span class="n">leave</span><span class="p">;</span><span class="k">iterate</span><span class="err">意思是重新开始复合语句，相当于</span> <span class="k">continue</span>
</span><span class='line'><span class="o">#</span><span class="err">该结果中</span><span class="mi">3</span><span class="err">将不被保存到数据库表中</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p20</span><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p20</span><span class="p">()</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">declare</span> <span class="n">v</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'><span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">loop_label</span><span class="p">:</span><span class="n">loop</span>
</span><span class='line'>    <span class="n">if</span> <span class="n">v</span><span class="o">=</span><span class="mi">3</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="k">iterate</span> <span class="n">loop_label</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'>    <span class="k">insert</span> <span class="k">into</span> <span class="n">casetest</span> <span class="k">values</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class='line'>    <span class="k">set</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">if</span> <span class="n">v</span><span class="o">&gt;=</span><span class="mi">5</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">leave</span> <span class="n">loop_label</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">loop</span> <span class="n">loop_label</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p20</span><span class="p">()</span><span class="o">//</span>
</span><span class='line'>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="n">Grand</span> <span class="n">combination</span><span class="err">大组合</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">procedure</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">p21</span><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="n">p21</span><span class="p">(</span><span class="k">in</span> <span class="n">par1</span> <span class="nb">int</span><span class="p">,</span><span class="k">out</span> <span class="n">par2</span> <span class="nb">int</span><span class="p">)</span>
</span><span class='line'><span class="k">language</span> <span class="k">sql</span> <span class="k">deterministic</span> <span class="k">sql</span> <span class="k">security</span> <span class="k">invoker</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="k">declare</span> <span class="n">v</span> <span class="nb">int</span><span class="p">;</span>
</span><span class='line'><span class="n">label</span> <span class="n">goto_label</span><span class="p">;</span>
</span><span class='line'><span class="n">start_label</span><span class="p">:</span><span class="n">loop</span>
</span><span class='line'>    <span class="n">if</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">leave</span> <span class="n">start_label</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">iterate</span> <span class="n">start_label</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span> <span class="n">if</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span> <span class="n">loop</span> <span class="n">start_label</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">repeat</span>
</span><span class='line'>    <span class="n">while</span> <span class="mi">1</span><span class="o">=</span><span class="mi">0</span> <span class="k">do</span> <span class="k">begin</span> <span class="k">end</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span> <span class="n">while</span><span class="p">;</span>
</span><span class='line'><span class="k">until</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span>
</span><span class='line'><span class="k">end</span> <span class="n">repeat</span><span class="p">;</span>
</span><span class='line'><span class="k">goto</span> <span class="n">goto_label</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="k">call</span> <span class="n">p21</span><span class="p">()</span><span class="o">//</span>
</span><span class='line'><span class="o">##</span> <span class="o">****************</span> <span class="k">trigger</span> <span class="o">***************************</span>
</span><span class='line'><span class="o">#&lt;</span><span class="mi">17</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">use</span> <span class="n">testprocedure</span><span class="p">;</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">trig1</span><span class="p">(</span><span class="n">a1</span> <span class="nb">int</span><span class="p">);</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">trig2</span><span class="p">(</span><span class="n">a2</span> <span class="nb">int</span><span class="p">);</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">trig3</span><span class="p">(</span><span class="n">a3</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">);</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">trig4</span><span class="p">(</span>
</span><span class='line'><span class="n">a4</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
</span><span class='line'><span class="n">b4</span> <span class="nb">INT</span> <span class="k">DEFAULT</span> <span class="mi">0</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="k">insert</span> <span class="k">into</span> <span class="n">trig3</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">),(</span><span class="k">null</span><span class="p">);</span>
</span><span class='line'><span class="k">insert</span> <span class="k">into</span> <span class="n">trig4</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="k">delimiter</span> <span class="o">//</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">trigger</span> <span class="n">trigtest</span><span class="o">//</span>
</span><span class='line'><span class="k">create</span> <span class="k">trigger</span> <span class="n">trigtest</span> <span class="k">before</span> <span class="k">insert</span> <span class="k">on</span> <span class="n">trig1</span>
</span><span class='line'><span class="k">for</span> <span class="k">each</span> <span class="k">row</span> <span class="k">begin</span>
</span><span class='line'><span class="k">insert</span> <span class="k">into</span> <span class="n">trig2</span> <span class="k">set</span> <span class="n">a2</span><span class="o">=</span><span class="k">NEW</span><span class="p">.</span><span class="n">a1</span><span class="p">;</span>
</span><span class='line'><span class="k">delete</span> <span class="k">from</span> <span class="n">trig3</span> <span class="k">where</span> <span class="n">a3</span><span class="o">=</span><span class="k">NEW</span><span class="p">.</span><span class="n">a1</span><span class="p">;</span>
</span><span class='line'><span class="k">update</span> <span class="n">trig4</span> <span class="k">set</span> <span class="n">b4</span><span class="o">=</span><span class="n">b4</span><span class="o">+</span><span class="mi">1</span> <span class="k">where</span> <span class="n">a4</span><span class="o">=</span><span class="k">NEW</span><span class="p">.</span><span class="n">a1</span><span class="p">;</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'>
</span><span class='line'><span class="k">delimiter</span> <span class="p">;</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">trig1</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'><span class="c1">------ -------------------------------------------------------------------------</span>
</span><span class='line'><span class="k">Drop</span> <span class="k">Procedure</span> <span class="n">If</span> <span class="k">Exists</span> <span class="n">p_report</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">Delimiter</span> <span class="n">forend</span>
</span><span class='line'>
</span><span class='line'><span class="k">Create</span> <span class="k">Procedure</span> <span class="n">p_report</span>
</span><span class='line'><span class="p">(</span><span class="k">In</span> <span class="k">year</span> <span class="nb">Int</span><span class="p">,</span>
</span><span class='line'><span class="k">In</span> <span class="k">month</span> <span class="nb">Int</span><span class="p">,</span>
</span><span class='line'><span class="k">In</span> <span class="n">Id</span> <span class="nb">Char</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
</span><span class='line'><span class="k">Out</span> <span class="n">status</span> <span class="nb">Int</span><span class="p">)</span>
</span><span class='line'><span class="k">Begin</span>
</span><span class='line'><span class="n">SelectYear</span><span class="p">,</span>
</span><span class='line'><span class="k">Month</span><span class="p">,</span>
</span><span class='line'><span class="n">OfficeId</span><span class="p">,</span>
</span><span class='line'><span class="n">OnTimeRate</span>
</span><span class='line'><span class="n">FromReportByMonth</span>
</span><span class='line'><span class="n">WhereOfficeId</span> <span class="o">=</span> <span class="n">Id</span> <span class="k">And</span>
</span><span class='line'><span class="k">Year</span> <span class="o">=</span> <span class="k">year</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">End</span>
</span><span class='line'>
</span><span class='line'><span class="n">forend</span>
</span><span class='line'>
</span><span class='line'><span class="k">Delimiter</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<h3>MySQL 存储过程参数有三种类型：in、out、inout。它们各有什么作用和特点呢？</h3>

<h4>一、MySQL 存储过程参数（in）</h4>

<p>MySQL 存储过程 “in” 参数：跟 C 语言的函数参数的值传递类似， MySQL 存储过程内部可能会修改此参数，但对 in 类型参数的修改，对调用者（caller）来说是不可见的（not visible）。
drop procedure if exists pr_param_in;create procedure pr_param_in( in id int &#8211; in 类型的 MySQL 存储过程参数)begin if (id is not null) then set id = id + 1; end if; select id as id_inner;end;set @id = 10;call pr_param_in(@id);select @id as id_out;mysql> call pr_param_in(@id);+&#8212;&#8212;&#8212;-+| id_inner |+&#8212;&#8212;&#8212;-+| 11 |+&#8212;&#8212;&#8212;-+mysql> select @id as id_out;+&#8212;&#8212;&#8211;+| id_out |+&#8212;&#8212;&#8211;+| 10 |+&#8212;&#8212;&#8211;+
可以看到：用户变量 @id 传入值为 10，执行存储过程后，在过程内部值为：11（id_inner），但外部变量值依旧为：10（id_out）。</p>

<h4>二、MySQL 存储过程参数（out）</h4>

<p>MySQL 存储过程 “out” 参数：从存储过程内部传值给调用者。在存储过程内部，该参数初始值为 null，无论调用者是否给存储过程参数设置值。
drop procedure if exists pr_param_out;create procedure pr_param_out( out id int)begin select id as id_inner_1; &#8211; id 初始值为 null if (id is not null) then set id = id + 1; select id as id_inner_2; else select 1 into id; end if; select id as id_inner_3;end;set @id = 10;call pr_param_out(@id);select @id as id_out;mysql> set @id = 10;mysql>mysql> call pr_param_out(@id);+&#8212;&#8212;&#8212;&#8212;+| id_inner_1 |+&#8212;&#8212;&#8212;&#8212;+| NULL |+&#8212;&#8212;&#8212;&#8212;++&#8212;&#8212;&#8212;&#8212;+| id_inner_3 |+&#8212;&#8212;&#8212;&#8212;+| 1 |+&#8212;&#8212;&#8212;&#8212;+mysql> select @id as id_out;+&#8212;&#8212;&#8211;+| id_out |+&#8212;&#8212;&#8211;+| 1 |+&#8212;&#8212;&#8211;+
可以看出，虽然我们设置了用户定义变量 @id 为 10，传递 @id 给存储过程后，在存储过程内部，id 的初始值总是 null（id_inner_1）。最后 id 值（id_out = 1）传回给调用者。</p>

<h4>三、MySQL 存储过程参数（inout）</h4>

<p>MySQL 存储过程 inout 参数跟 out 类似，都可以从存储过程内部传值给调用者。不同的是：调用者还可以通过 inout 参数传递值给存储过程。
drop procedure if exists pr_param_inout;create procedure pr_param_inout( inout id int)begin select id as id_inner_1; &#8211; id 值为调用者传进来的值 if (id is not null) then set id = id + 1; select id as id_inner_2; else select 1 into id; end if; select id as id_inner_3;end;set @id = 10;call pr_param_inout(@id);select @id as id_out;mysql> set @id = 10;mysql>mysql> call pr_param_inout(@id);+&#8212;&#8212;&#8212;&#8212;+| id_inner_1 |+&#8212;&#8212;&#8212;&#8212;+| 10 |+&#8212;&#8212;&#8212;&#8212;++&#8212;&#8212;&#8212;&#8212;+| id_inner_2 |+&#8212;&#8212;&#8212;&#8212;+| 11 |+&#8212;&#8212;&#8212;&#8212;++&#8212;&#8212;&#8212;&#8212;+| id_inner_3 |+&#8212;&#8212;&#8212;&#8212;+| 11 |+&#8212;&#8212;&#8212;&#8212;+mysql>mysql> select @id as id_out;+&#8212;&#8212;&#8211;+| id_out |+&#8212;&#8212;&#8211;+| 11 |+&#8212;&#8212;&#8211;+
从结果可以看出：我们把 @id（10），传给存储过程后，存储过程最后又把计算结果值 11（id_inner_3）传回给调用者。 MySQL 存储过程 inout 参数的行为跟 C 语言函数中的引用传值类似。
通过以上例子：如果仅仅想把数据传给 MySQL 存储过程，那就使用“in” 类型参数；如果仅仅从 MySQL 存储过程返回值，那就使用“out” 类型参数；如果需要把数据传给 MySQL 存储过程，还要经过一些计算后再传回给我们，此时，要使用“inout” 类型参数。</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-01-03T19:02:00+08:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/mysql/'>MySQL</a>


</div>
	
		<span class="comments"><a href="/blog/2012/01/03/mysql-sp/#disqus_thread">Comments</a></span>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2012

    Woody.Xu

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'woodyxu';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://woody1983.github.com/blog/2012/01/03/mysql-sp/';
        var disqus_url = 'http://woody1983.github.com/blog/2012/01/03/mysql-sp/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>